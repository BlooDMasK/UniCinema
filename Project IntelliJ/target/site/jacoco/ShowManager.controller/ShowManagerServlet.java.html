<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShowManagerServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">UniCinema</a> &gt; <a href="index.source.html" class="el_package">ShowManager.controller</a> &gt; <span class="el_source">ShowManagerServlet.java</span></div><h1>ShowManagerServlet.java</h1><pre class="source lang-java linenums">package ShowManager.controller;

import ShowManager.service.ShowService;
import ShowManager.service.ShowServiceMethods;
import model.bean.Film;
import model.bean.Room;
import model.bean.Show;
import org.json.JSONArray;
import org.json.JSONObject;
import utils.Controller;
import utils.ErrorHandler;
import utils.InvalidRequestException;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.IOException;
import java.sql.SQLException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.ArrayList;

@WebServlet(name = &quot;ShowManagerServlet&quot;, value = &quot;/show-manager/*&quot;)
public class ShowManagerServlet extends Controller implements ErrorHandler {

    ShowService showService;
    JSONObject jsonObject;

    public void setJsonObject(JSONObject jsonObject) {
<span class="fc" id="L31">        this.jsonObject = jsonObject;</span>
<span class="fc" id="L32">    }</span>

<span class="fc" id="L34">    public ShowManagerServlet() {</span>
<span class="fc" id="L35">        showService = new ShowServiceMethods();</span>
<span class="fc" id="L36">        jsonObject = new JSONObject();</span>
<span class="fc" id="L37">    }</span>

    public void setShowService(ShowService showService) {
<span class="fc" id="L40">        this.showService = showService;</span>
<span class="fc" id="L41">    }</span>

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

<span class="nc" id="L46">    }</span>

    @Override
    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try {
<span class="fc" id="L51">            HttpSession session = request.getSession();</span>
<span class="fc" id="L52">            String path = getPath(request);</span>
<span class="pc bpc" id="L53" title="2 of 6 branches missed.">            switch(path) {</span>
                case &quot;/remove&quot;:
<span class="fc" id="L55">                    authorize(session);</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">                    if(isAjax(request)) {</span>
<span class="fc" id="L57">                        int showId = Integer.parseInt(request.getParameter(&quot;showId&quot;));</span>
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">                        if(showService.remove(showId)) {</span>
<span class="fc" id="L59">                            jsonObject.put(&quot;result&quot;, &quot;success&quot;);</span>
<span class="fc" id="L60">                            sendJson(response, jsonObject);</span>
                        } else
<span class="nc" id="L62">                            internalError();</span>
<span class="fc" id="L63">                    }</span>
                    break;

                case &quot;/add&quot;: {
<span class="fc" id="L67">                    authorize(session);</span>

<span class="fc" id="L69">                    int roomId = Integer.parseInt(request.getParameter(&quot;room&quot;)),</span>
<span class="fc" id="L70">                        filmId = Integer.parseInt(request.getParameter(&quot;filmId&quot;));</span>

<span class="fc" id="L72">                    LocalDate date = getLocalDateFromString(request, &quot;date&quot;);</span>
<span class="fc" id="L73">                    LocalTime time = getLocalTimeFromString(request, &quot;time&quot;);</span>

<span class="fc" id="L75">                    Film film = new Film();</span>
<span class="fc" id="L76">                    film.setId(filmId);</span>

<span class="fc" id="L78">                    Room room = new Room();</span>
<span class="fc" id="L79">                    room.setId(roomId);</span>

<span class="fc" id="L81">                    Show show = new Show(date, time);</span>
<span class="fc" id="L82">                    show.setFilm(film);</span>
<span class="fc" id="L83">                    show.setRoom(room);</span>

<span class="pc bpc" id="L85" title="1 of 2 branches missed.">                    if (showService.insert(show)) {</span>
<span class="fc" id="L86">                        response.sendRedirect(getServletContext().getContextPath()+&quot;/film/details?filmId=&quot;+filmId);</span>
                    } else
<span class="nc" id="L88">                        internalError();</span>
<span class="nc" id="L89">                    break;</span>
                }

                case &quot;/update&quot;: {
<span class="fc" id="L93">                    authorize(session);</span>

<span class="fc" id="L95">                    int showId = Integer.parseInt(request.getParameter(&quot;showId&quot;)),</span>
<span class="fc" id="L96">                        filmId = Integer.parseInt(request.getParameter(&quot;filmId&quot;));</span>

<span class="fc" id="L98">                    LocalDate date = getLocalDateFromString(request, &quot;date&quot;);</span>
<span class="fc" id="L99">                    LocalTime time = getLocalTimeFromString(request, &quot;time&quot;);</span>

<span class="fc" id="L101">                    Show show = new Show(date, time);</span>
<span class="fc" id="L102">                    show.setId(showId);</span>

<span class="pc bpc" id="L104" title="1 of 2 branches missed.">                    if(showService.update(show)) {</span>
<span class="fc" id="L105">                        response.sendRedirect(getServletContext().getContextPath()+&quot;/film/details?filmId=&quot;+filmId);</span>
                    } else
<span class="nc" id="L107">                        internalError();</span>
<span class="nc" id="L108">                    break;</span>
                }

                case &quot;/get-show&quot;: {
<span class="fc" id="L112">                    authorize(session);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                    if(isAjax(request)) {</span>
<span class="fc" id="L114">                        int showId = Integer.parseInt(request.getParameter(&quot;showId&quot;));</span>

<span class="fc" id="L116">                        Show show = showService.fetch(showId);</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">                        if(show != null) {</span>
<span class="fc" id="L118">                            int roomId = show.getRoom().getId();</span>
<span class="fc" id="L119">                            LocalDate date = show.getDate();</span>

<span class="fc" id="L121">                            ArrayList&lt;Show&gt; showList = showService.fetchDaily(roomId, date, show);</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">                            if (!showList.isEmpty())</span>
<span class="fc" id="L123">                                jsonObject.put(&quot;timeList&quot;, getAvailableDateList(show.getFilm().getLength(), date, showList));</span>
                            else {
<span class="nc" id="L125">                                JSONArray list = new JSONArray();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                                for (int i = STARTING_HOUR; i &lt;= ENDING_HOUR; i++)</span>
<span class="nc" id="L127">                                    list.put(i + &quot;:00&quot;);</span>

<span class="nc" id="L129">                                jsonObject.put(&quot;timeList&quot;, list);</span>
                            }

<span class="fc" id="L132">                            jsonObject.put(&quot;roomId&quot;, roomId);</span>
<span class="fc" id="L133">                            jsonObject.put(&quot;date&quot;, date);</span>
<span class="fc" id="L134">                            sendJson(response, jsonObject);</span>
<span class="fc" id="L135">                        } else</span>
<span class="nc" id="L136">                            notFound();</span>
<span class="fc" id="L137">                    }</span>
                    break;
                }

                case &quot;/get-all-show&quot;: {
<span class="nc" id="L142">                    authorize(session);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                    if (isAjax(request)) {</span>
<span class="nc" id="L144">                        int roomId = Integer.parseInt(request.getParameter(&quot;room&quot;)),</span>
<span class="nc" id="L145">                            filmLength = Integer.parseInt(request.getParameter(&quot;film-length&quot;));</span>

<span class="nc" id="L147">                        String stringDate = request.getParameter(&quot;date&quot;);</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">                        if(!stringDate.isEmpty() &amp;&amp; !stringDate.isBlank()) {</span>
<span class="nc" id="L149">                            LocalDate date = getLocalDateFromString(request, &quot;date&quot;);</span>
<span class="nc" id="L150">                            ArrayList&lt;Show&gt; showList = showService.fetchDaily(roomId, date);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                            if (!showList.isEmpty()) {</span>
<span class="nc" id="L152">                                jsonObject.put(&quot;timeList&quot;, getAvailableDateList(filmLength, date, showList));</span>
<span class="nc" id="L153">                                sendJson(response, jsonObject);</span>
                            } else {
<span class="nc" id="L155">                                JSONArray list = new JSONArray();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                                for (int i = STARTING_HOUR; i &lt;= ENDING_HOUR; i++)</span>
<span class="nc" id="L157">                                    list.put(i + &quot;:00&quot;);</span>

<span class="nc" id="L159">                                jsonObject.put(&quot;timeList&quot;, list);</span>
<span class="nc" id="L160">                                sendJson(response, jsonObject);</span>
                            }
                        }
                    }
                    break;
                }
            }
<span class="nc" id="L167">        } catch (SQLException ex) {</span>
<span class="nc" id="L168">            log(ex.getMessage());</span>
<span class="nc" id="L169">            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, ex.getMessage());</span>
<span class="nc" id="L170">        } catch (InvalidRequestException e) {</span>
<span class="nc" id="L171">            log(e.getMessage());</span>
<span class="nc" id="L172">            e.handle(request, response);</span>
<span class="pc" id="L173">        }</span>
<span class="fc" id="L174">    }</span>

    private boolean isOverlapping(LocalDateTime start1, LocalDateTime end1, LocalDateTime start2, LocalDateTime end2) {
<span class="nc bnc" id="L177" title="All 4 branches missed.">        return start1.isBefore(end2) &amp;&amp; start2.isBefore(end1);</span>
    }

    private long toHour(int filmMinutes) {
<span class="fc" id="L181">        double minutes = Math.ceil((double) filmMinutes/60); //approssimo per eccesso per qualsiasi valore decimale.</span>
<span class="fc" id="L182">        return (long) minutes;</span>
    }

    public JSONArray getAvailableDateList(int filmLength, LocalDate date, ArrayList&lt;Show&gt; showList) {
<span class="fc" id="L186">        long hourTime = toHour(filmLength) + 1; //Aggiungo 1 ora per liberare la sala</span>
<span class="fc" id="L187">        LocalTime time = LocalTime.of(STARTING_HOUR, 0);</span>
<span class="fc" id="L188">        LocalDateTime localDateTime = LocalDateTime.of(date, time);</span>

<span class="fc" id="L190">        JSONArray list = new JSONArray();</span>

        boolean skipFlag;
        do {
<span class="fc" id="L194">            skipFlag = false;</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            for (Show show : showList) {</span>
<span class="nc" id="L196">                LocalTime showTime = show.getTime();</span>
<span class="nc" id="L197">                LocalDateTime showDateTime = LocalDateTime.of(date, showTime);</span>
<span class="nc" id="L198">                long showLength = toHour(show.getFilm().getLength()) + 1;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (isOverlapping(localDateTime, localDateTime.plusHours(hourTime), showDateTime, showDateTime.plusHours(showLength))) {</span>
<span class="nc" id="L200">                    skipFlag = true;</span>
<span class="nc" id="L201">                    break;</span>
                }
<span class="nc" id="L203">            }</span>

<span class="pc bpc" id="L205" title="1 of 2 branches missed.">            if (!skipFlag)</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">                list.put(localDateTime.getHour() + &quot;:&quot; + (localDateTime.getMinute() &lt; 10 ? localDateTime.getMinute() + &quot;0&quot; : localDateTime.getMinute()));</span>

<span class="fc" id="L208">            localDateTime = localDateTime.plusHours(1);</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">        } while (localDateTime.getHour() &lt;= ENDING_HOUR);</span>

<span class="fc" id="L211">        return list;</span>
    }

<span class="fc" id="L214">    private static int STARTING_HOUR = 16, ENDING_HOUR = 22;</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>